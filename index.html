<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>acer.fyi | MBTA 3D</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

    <script src='https://unpkg.com/leaflet.marker.slideto@0.2.0/Leaflet.Marker.SlideTo.js'></script>

    <script src="leaflet-svg-shape-markers.min.js"></script>

    <link rel="stylesheet" href="global.css">
</head>
<body>
    <div id="map"></div>
</body>

<script>
    var map = L.map('map').setView([42.3001, -71.1589], 12);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    const redLine = [
      [
        -71.1406673,
        42.3961391
      ],
      [
        -71.1395108,
        42.3961193
      ],
      [
        -71.1384779,
        42.3964442
      ],
      [
        -71.1376192,
        42.3970424
      ],
      [
        -71.1367444,
        42.397593
      ],
      [
        -71.1360359,
        42.3978743
      ],
      [
        -71.1353275,
        42.3980129
      ],
      [
        -71.1347586,
        42.3979931
      ],
      [
        -71.1308783,
        42.3977198
      ],
      [
        -71.1274864,
        42.3975296
      ],
      [
        -71.1249586,
        42.3973553
      ],
      [
        -71.123413,
        42.3969988
      ],
      [
        -71.1208744,
        42.3964125
      ],
      [
        -71.1202089,
        42.3961154
      ],
      [
        -71.1197581,
        42.3957588
      ],
      [
        -71.119522,
        42.3954419
      ],
      [
        -71.1193288,
        42.3949229
      ],
      [
        -71.1192107,
        42.3941821
      ],
      [
        -71.1190121,
        42.3924468
      ],
      [
        -71.1188511,
        42.3904064
      ],
      [
        -71.1188994,
        42.3897328
      ],
      [
        -71.1190121,
        42.3886037
      ],
      [
        -71.1191087,
        42.3874546
      ],
      [
        -71.1192965,
        42.385735
      ],
      [
        -71.1194898,
        42.3838965
      ],
      [
        -71.1197259,
        42.3816379
      ],
      [
        -71.120225,
        42.3787848
      ],
      [
        -71.1203807,
        42.3777783
      ],
      [
        -71.1202948,
        42.3774929
      ],
      [
        -71.1200917,
        42.37695
      ],
      [
        -71.1197689,
        42.3765815
      ],
      [
        -71.119259,
        42.3761258
      ],
      [
        -71.1190336,
        42.375884
      ],
      [
        -71.1188619,
        42.3755828
      ],
      [
        -71.1188243,
        42.375032
      ],
      [
        -71.118776,
        42.3741879
      ],
      [
        -71.1187706,
        42.3735578
      ],
      [
        -71.1185667,
        42.37332
      ],
      [
        -71.1179119,
        42.3730941
      ],
      [
        -71.1163394,
        42.37267
      ],
      [
        -71.1160402,
        42.3725313
      ],
      [
        -71.1148649,
        42.3715881
      ],
      [
        -71.1137647,
        42.3707201
      ],
      [
        -71.1126913,
        42.3698839
      ],
      [
        -71.1118648,
        42.3695866
      ],
      [
        -71.1097341,
        42.3687583
      ],
      [
        -71.1087627,
        42.3683461
      ],
      [
        -71.1076464,
        42.3677912
      ],
      [
        -71.1065891,
        42.3671412
      ],
      [
        -71.1048878,
        42.366083
      ],
      [
        -71.1034226,
        42.3652308
      ],
      [
        -71.1009074,
        42.3637247
      ],
      [
        -71.1003117,
        42.3635106
      ],
      [
        -71.0996006,
        42.3634274
      ],
      [
        -71.0980871,
        42.3632986
      ],
      [
        -71.095943,
        42.3631261
      ],
      [
        -71.093866,
        42.3629755
      ],
      [
        -71.0915046,
        42.362809
      ],
      [
        -71.089178,
        42.3626584
      ],
      [
        -71.0874714,
        42.3625217
      ],
      [
        -71.0851851,
        42.3623433
      ],
      [
        -71.083889,
        42.3622046
      ],
      [
        -71.082083,
        42.3620262
      ],
      [
        -71.0804219,
        42.3619013
      ],
      [
        -71.0780444,
        42.361715
      ],
      [
        -71.075954,
        42.3615644
      ],
      [
        -71.0738314,
        42.361394
      ],
      [
        -71.0714377,
        42.3612077
      ],
      [
        -71.0708393,
        42.361166
      ],
      [
        -71.0705146,
        42.3611403
      ],
      [
        -71.0701094,
        42.3610452
      ],
      [
        -71.0696184,
        42.3608767
      ],
      [
        -71.0691112,
        42.3605754
      ],
      [
        -71.0684001,
        42.3600245
      ],
      [
        -71.0675248,
        42.3593744
      ],
      [
        -71.0665588,
        42.3586569
      ],
      [
        -71.0652922,
        42.3577808
      ],
      [
        -71.064251,
        42.3571704
      ],
      [
        -71.063293,
        42.3567641
      ],
      [
        -71.0626222,
        42.3564271
      ],
      [
        -71.0616722,
        42.3560188
      ],
      [
        -71.0605613,
        42.3554737
      ],
      [
        -71.0596945,
        42.3548513
      ],
      [
        -71.0583582,
        42.3538781
      ],
      [
        -71.0570942,
        42.3532835
      ],
      [
        -71.0562436,
        42.3529961
      ],
      [
        -71.0552266,
        42.3526214
      ],
      [
        -71.0533481,
        42.3517116
      ],
      [
        -71.0528651,
        42.3512438
      ],
      [
        -71.0526826,
        42.350659
      ],
      [
        -71.0527014,
        42.3503835
      ],
      [
        -71.0529671,
        42.3498443
      ],
      [
        -71.0533133,
        42.3493071
      ],
      [
        -71.0537453,
        42.3486351
      ],
      [
        -71.0542605,
        42.3479017
      ],
      [
        -71.054977,
        42.346855
      ],
      [
        -71.0554627,
        42.3461235
      ],
      [
        -71.0563268,
        42.3448171
      ],
      [
        -71.0571103,
        42.3434829
      ],
      [
        -71.0571962,
        42.342898
      ],
      [
        -71.0571801,
        42.3417958
      ],
      [
        -71.0571533,
        42.3406162
      ],
      [
        -71.0571399,
        42.3392601
      ],
      [
        -71.0570916,
        42.3381022
      ],
      [
        -71.057062,
        42.3366906
      ],
      [
        -71.0570728,
        42.3349854
      ],
      [
        -71.0570486,
        42.3334884
      ],
      [
        -71.0570191,
        42.3317832
      ],
      [
        -71.0570191,
        42.330885
      ],
      [
        -71.0571694,
        42.3299808
      ],
      [
        -71.0573384,
        42.3291717
      ],
      [
        -71.0576792,
        42.3284876
      ],
      [
        -71.0579637,
        42.327859
      ],
      [
        -71.0579073,
        42.3273613
      ],
      [
        -71.0577812,
        42.3271115
      ],
      [
        -71.0575155,
        42.3267743
      ],
      [
        -71.0571399,
        42.3264868
      ],
      [
        -71.0565093,
        42.3259851
      ],
      [
        -71.0561524,
        42.3256797
      ]
    ]
    var redLinePolyline = L.polyline(redLine.map(([lat, lng]) => [lng, lat]), {color: 'red'}).addTo(map);

    const braintree = [
      [
        -71.0564589,
        42.3259197
      ],
      [
        -71.0553855,
        42.325184
      ],
      [
        -71.0542128,
        42.3243451
      ],
      [
        -71.0533729,
        42.3236748
      ],
      [
        -71.0530338,
        42.3232366
      ],
      [
        -71.0527584,
        42.3226139
      ],
      [
        -71.0526135,
        42.3221677
      ],
      [
        -71.0525179,
        42.3218781
      ],
      [
        -71.0523257,
        42.3209242
      ],
      [
        -71.0523542,
        42.3202301
      ],
      [
        -71.05222,
        42.3194804
      ],
      [
        -71.0521583,
        42.3185186
      ],
      [
        -71.0521476,
        42.3176519
      ],
      [
        -71.0520859,
        42.3166126
      ],
      [
        -71.0520698,
        42.3156844
      ],
      [
        -71.052059,
        42.3146689
      ],
      [
        -71.0522227,
        42.3137348
      ],
      [
        -71.0525179,
        42.312864
      ],
      [
        -71.0528882,
        42.3119358
      ],
      [
        -71.0532505,
        42.3110333
      ],
      [
        -71.0536932,
        42.3099364
      ],
      [
        -71.0540582,
        42.3088772
      ],
      [
        -71.0543802,
        42.3078477
      ],
      [
        -71.0547049,
        42.3065663
      ],
      [
        -71.0551763,
        42.3047552
      ],
      [
        -71.0555359,
        42.3031524
      ],
      [
        -71.0555976,
        42.3029282
      ],
      [
        -71.0555788,
        42.3023549
      ],
      [
        -71.055501,
        42.3017657
      ],
      [
        -71.0553615,
        42.3012956
      ],
      [
        -71.0549858,
        42.3005397
      ],
      [
        -71.0542478,
        42.2996847
      ],
      [
        -71.0532388,
        42.2987463
      ],
      [
        -71.0521397,
        42.2977563
      ],
      [
        -71.0509832,
        42.2967346
      ],
      [
        -71.0498212,
        42.295697
      ],
      [
        -71.0484392,
        42.2944828
      ],
      [
        -71.047352,
        42.2934888
      ],
      [
        -71.0460908,
        42.2923599
      ],
      [
        -71.0441426,
        42.2906079
      ],
      [
        -71.0428063,
        42.2894829
      ],
      [
        -71.0414377,
        42.2882527
      ],
      [
        -71.0402516,
        42.2871931
      ],
      [
        -71.0388991,
        42.2860025
      ],
      [
        -71.0377533,
        42.2849608
      ],
      [
        -71.0367873,
        42.2840996
      ],
      [
        -71.0352362,
        42.2826986
      ],
      [
        -71.0338918,
        42.2814921
      ],
      [
        -71.0331163,
        42.2805614
      ],
      [
        -71.0328131,
        42.2799502
      ],
      [
        -71.0326118,
        42.2794977
      ],
      [
        -71.032322,
        42.2787059
      ],
      [
        -71.0317451,
        42.2774278
      ],
      [
        -71.031466,
        42.2770706
      ],
      [
        -71.0308166,
        42.2764098
      ],
      [
        -71.0303067,
        42.2759196
      ],
      [
        -71.0293568,
        42.2750126
      ],
      [
        -71.028211,
        42.273931
      ],
      [
        -71.0267887,
        42.2725853
      ],
      [
        -71.0252484,
        42.2711305
      ],
      [
        -71.0238584,
        42.2698087
      ],
      [
        -71.0231822,
        42.2691993
      ],
      [
        -71.0219505,
        42.2680878
      ],
      [
        -71.0207536,
        42.2670239
      ],
      [
        -71.0201633,
        42.2664821
      ],
      [
        -71.0192133,
        42.2654856
      ],
      [
        -71.0182822,
        42.2645944
      ],
      [
        -71.0176543,
        42.263985
      ],
      [
        -71.0164601,
        42.2628734
      ],
      [
        -71.0153358,
        42.2617936
      ],
      [
        -71.0142436,
        42.2607435
      ],
      [
        -71.0131353,
        42.2597013
      ],
      [
        -71.0121398,
        42.2587683
      ],
      [
        -71.0108302,
        42.2575633
      ],
      [
        -71.0095905,
        42.2563821
      ],
      [
        -71.008281,
        42.2551254
      ],
      [
        -71.0069178,
        42.253837
      ],
      [
        -71.0060456,
        42.2528682
      ],
      [
        -71.0056243,
        42.2521773
      ],
      [
        -71.0049615,
        42.2510873
      ],
      [
        -71.0038191,
        42.2491416
      ],
      [
        -71.0036205,
        42.2486214
      ],
      [
        -71.0034863,
        42.2479821
      ],
      [
        -71.0034917,
        42.2475016
      ],
      [
        -71.003701,
        42.2463698
      ],
      [
        -71.0041196,
        42.244289
      ],
      [
        -71.0046856,
        42.242065
      ],
      [
        -71.0055496,
        42.2388124
      ],
      [
        -71.0064345,
        42.2353055
      ],
      [
        -71.0069551,
        42.2327873
      ],
      [
        -71.0070571,
        42.2319135
      ],
      [
        -71.0070785,
        42.2313693
      ],
      [
        -71.0069175,
        42.2304558
      ],
      [
        -71.0060159,
        42.2284061
      ],
      [
        -71.004175,
        42.2255779
      ],
      [
        -71.0019263,
        42.2221893
      ],
      [
        -71.0009712,
        42.2208943
      ],
      [
        -71.000558,
        42.2200242
      ],
      [
        -71.0002496,
        42.2189218
      ],
      [
        -71.0001144,
        42.2178591
      ],
      [
        -71.0005107,
        42.2145496
      ],
      [
        -71.0013265,
        42.208987
      ],
      [
        -71.0019672,
        42.2056811
      ],
      [
        -71.0021361,
        42.2041234
      ]
    ]
    const braintreePolyline = L.polyline(braintree.map(([lat, lng]) => [lng, lat]), {color: 'red'}).addTo(map);

    const ashmont = [
      [
        -71.0564531,
        42.3259177
      ],
      [
        -71.055581,
        42.3251879
      ],
      [
        -71.0543417,
        42.3242579
      ],
      [
        -71.0532768,
        42.3230759
      ],
      [
        -71.0528034,
        42.3222311
      ],
      [
        -71.0525726,
        42.3215093
      ],
      [
        -71.0525136,
        42.3208469
      ],
      [
        -71.0523687,
        42.3199505
      ],
      [
        -71.0522882,
        42.3188756
      ],
      [
        -71.0522131,
        42.3173683
      ],
      [
        -71.052154,
        42.3161029
      ],
      [
        -71.0521218,
        42.3148217
      ],
      [
        -71.0522238,
        42.3141394
      ],
      [
        -71.0524814,
        42.3131913
      ],
      [
        -71.0530932,
        42.3117037
      ],
      [
        -71.0538155,
        42.3101328
      ],
      [
        -71.0542234,
        42.3091489
      ],
      [
        -71.054632,
        42.3076811
      ],
      [
        -71.0551686,
        42.3055546
      ],
      [
        -71.0556087,
        42.3039518
      ],
      [
        -71.055759,
        42.3030552
      ],
      [
        -71.0558019,
        42.3023251
      ],
      [
        -71.0557805,
        42.3018411
      ],
      [
        -71.0559307,
        42.301246
      ],
      [
        -71.0562313,
        42.3009444
      ],
      [
        -71.0570471,
        42.3004921
      ],
      [
        -71.0577464,
        42.3003651
      ],
      [
        -71.0587228,
        42.3003017
      ],
      [
        -71.0593558,
        42.3003017
      ],
      [
        -71.0602357,
        42.300262
      ],
      [
        -71.0607288,
        42.3002223
      ],
      [
        -71.061405,
        42.3001033
      ],
      [
        -71.0627789,
        42.2997224
      ],
      [
        -71.0635625,
        42.299524
      ],
      [
        -71.064228,
        42.2991986
      ],
      [
        -71.0649471,
        42.2987939
      ],
      [
        -71.0657522,
        42.2980162
      ],
      [
        -71.0661601,
        42.2973734
      ],
      [
        -71.0664261,
        42.2965164
      ],
      [
        -71.0664778,
        42.2956117
      ],
      [
        -71.0661236,
        42.2943657
      ],
      [
        -71.0656943,
        42.2926039
      ],
      [
        -71.0650502,
        42.2896436
      ],
      [
        -71.0643847,
        42.2861831
      ],
      [
        -71.0641271,
        42.2851671
      ],
      [
        -71.0634509,
        42.2839289
      ],
      [
        -71.0626888,
        42.2825716
      ],
      [
        -71.0623775,
        42.2819683
      ]
    ]
    const ashmontPolyline = L.polyline(ashmont.map(([lat, lng]) => [lng, lat]), {color: 'red'}).addTo(map);

    const mattapan = [
      [
        -71.0634214,
        42.2839309
      ],
      [
        -71.0629733,
        42.2835975
      ],
      [
        -71.0627721,
        42.2832741
      ],
      [
        -71.062077,
        42.2821866
      ],
      [
        -71.0605167,
        42.2797855
      ],
      [
        -71.0597429,
        42.2784638
      ],
      [
        -71.0592223,
        42.2770389
      ],
      [
        -71.0588547,
        42.2758263
      ],
      [
        -71.0588976,
        42.2753262
      ],
      [
        -71.0591112,
        42.274832
      ],
      [
        -71.0596156,
        42.2743636
      ],
      [
        -71.0611506,
        42.2733157
      ],
      [
        -71.0631363,
        42.271982
      ],
      [
        -71.0645532,
        42.2710611
      ],
      [
        -71.065487,
        42.2707276
      ],
      [
        -71.0662921,
        42.2704498
      ],
      [
        -71.0677411,
        42.2703148
      ],
      [
        -71.0701884,
        42.2702751
      ],
      [
        -71.0713827,
        42.2702513
      ],
      [
        -71.0727968,
        42.2700846
      ],
      [
        -71.074965,
        42.2698384
      ],
      [
        -71.0784194,
        42.2690842
      ],
      [
        -71.0835146,
        42.2678219
      ],
      [
        -71.0850603,
        42.2674487
      ],
      [
        -71.085758,
        42.2673931
      ],
      [
        -71.0865737,
        42.2674408
      ],
      [
        -71.0878618,
        42.267679
      ],
      [
        -71.0890211,
        42.2679092
      ],
      [
        -71.0898368,
        42.2679092
      ],
      [
        -71.0918118,
        42.2676075
      ],
      [
        -71.0924022,
        42.2675122
      ]
    ]
    const mattapanPolyline = L.polyline(mattapan.map(([lat, lng]) => [lng, lat]), {color: 'red'}).addTo(map);

    const trainMarkers = {}

    // async function getTrains() {
    //     const response = await fetch('https://api-v3.mbta.com/vehicles?filter[route]=Red')
    //     const trains = await response.json()

    //     trains["data"].forEach((train) => {
    //         if (train["id"] in trainMarkers) {
    //             trainMarkers[train["id"]].slideTo([train["attributes"]["latitude"], train["attributes"]["longitude"]], {
    //                 duration: 5000
    //             })
    //             trainMarkers[train["id"]].setRotation(train["attributes"]["bearing"])
    //             trainMarkers[train["id"]].setStyle({color: train["attributes"]["current_status"] == "STOPPED_AT" ? "black" : "red"})
    //         } else {
    //             trainMarkers[train["id"]] = L.shapeMarker([train["attributes"]["latitude"], train["attributes"]["longitude"]], {shape: "arrowhead", rotation: train["attributes"]["bearing"], radius: 5, weight: 1, color: train["attributes"]["current_status"] == "STOPPED_AT" ? "black" : "red", fill: true, fillOpacity: 1, fillColor: "red"}).addTo(map);
    //         }
    //     })

    //     console.log("refresh")
    // }

    // getTrains()
    // const interval = setInterval(getTrains, 5000);

    const evtSource = new EventSource("https://api-v3.mbta.com/vehicles?filter[route]=Red&api_key=b0f13f7a6f7e4ea292bfd81eef538234",)

    evtSource.addEventListener("reset", (e) => {
        trainData = JSON.parse(e.data)
        trainData.forEach((train) => {
            trainMarkers[train["id"]] = L.shapeMarker([train["attributes"]["latitude"], train["attributes"]["longitude"]], {shape: "arrowhead", rotation: train["attributes"]["bearing"], radius: 5, weight: 1, color: train["attributes"]["current_status"] == "STOPPED_AT" ? "black" : "darkred", fill: true, fillOpacity: 1, fillColor: "red"}).addTo(map);
        })
    });

    evtSource.addEventListener("add", (e) => {
        train = JSON.parse(e.data)
        trainMarkers[train["id"]] = L.shapeMarker([train["attributes"]["latitude"], train["attributes"]["longitude"]], {shape: "arrowhead", rotation: train["attributes"]["bearing"], radius: 5, weight: 1, color: train["attributes"]["current_status"] == "STOPPED_AT" ? "black" : "darkred", fill: true, fillOpacity: 1, fillColor: "red"}).addTo(map);
    });

    evtSource.addEventListener("update", (e) => {
        train = JSON.parse(e.data)
        trainMarkers[train["id"]].slideTo([train["attributes"]["latitude"], train["attributes"]["longitude"]], {
            duration: 5000
        })
        trainMarkers[train["id"]].setRotation(train["attributes"]["bearing"])
        trainMarkers[train["id"]].setStyle({color: train["attributes"]["current_status"] == "STOPPED_AT" ? "black" : "darkred"})
    });

    evtSource.addEventListener("remove", (e) => {
        console.log(e.data);
    });

</script>
</html>